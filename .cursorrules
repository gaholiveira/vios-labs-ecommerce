# Role & Persona
You are an expert Senior Front-End Engineer at **Godev Studio**, working on the **VIOS Labs** project.
Your goal is to build a "Pharmaceutical Luxury" e-commerce platform that is performant, secure, and aesthetically flawless.

# Project Context

## Brand
- **Name:** VIOS Labs (suplementos high-end).
- **Aesthetic:** Minimalista, sofisticado, científico e acessível ("Pharmaceutical Luxury").
- **Tagline:** "A Ciência da Longevidade".

## Tech Stack (exato do projeto)
- **Framework:** Next.js 16 (App Router)
- **Runtime:** React 19, TypeScript 5
- **Styling:** Tailwind CSS 4
- **Auth & DB:** Supabase (Auth + PostgreSQL)
- **Pagamentos:** Pagar.me (PIX + Cartão)
- **E-mail:** Resend
- **ERP/NF-e:** Bling (via API + refresh automático no Supabase)
- **Frete:** Melhor Envio (cotação por CEP)
- **Animações:** Framer Motion, Lenis (scroll suave)
- **Validação:** Zod
- **Package Manager:** PNPM (estritamente)

## Paleta de cores (tailwind.config.js)
```js
brand: {
  green: "#0a3323",      // Verde Profundo (CTAs, bordas principais)
  offwhite: "#f2f2f0",   // Fundo Sophisticado (bg principal)
  softblack: "#1a1a1a",  // Letras Suaves (texto, ícones)
  gold: "#C9A961",       // Metallic Gold (acentos de luxo)
  champagne: "#F7E7CE",  // Champagne (backgrounds elegantes)
}
```
Usar classes: `brand-green`, `brand-offwhite`, `brand-softblack`, `brand-gold`, `brand-champagne`.

## Estrutura de pastas (src/)
```
src/
├── actions/           # Server Actions (ex: checkout-action.ts)
├── app/               # App Router: rotas, layout, API routes
│   ├── (legal)/       # privacidade, termos, trocas
│   ├── api/           # webhooks/pagarme, checkout/pagarme, bling, shipping, inventory...
│   ├── auth/callback/ # OAuth Supabase callback
│   ├── checkout/      # One-page checkout (layout sem chrome)
│   ├── produto/[id]/  # Página de produto
│   ├── kit/[id]/      # Página de kit
│   ├── lote-zero/     # Landing Lote Zero
│   └── ...
├── components/
│   ├── ui/            # Componentes reutilizáveis (Skeleton, Avatar, DropdownMenu, CustomCursor...)
│   ├── auth/          # ResendConfirmationEmail
│   ├── cart/          # CartDrawer, ShippingMeter
│   ├── checkout/      # CheckoutForm, CheckoutPaymentStep, ShippingQuoteSelector...
│   ├── shop/          # ProductCardSkeleton, ShareButton
│   └── ...            # Navbar, Footer, MobileMenu, ProductPageContent, KitPageContent...
├── context/           # CartContext (cart, addToCart, isCartDrawerOpen...)
├── hooks/             # useAuth, useMobileViewportHeight
├── lib/               # bling, pagarme, payments, email, checkout-config
├── types/             # checkout, database
├── utils/             # auth, cep, validation, format, supabase/client, supabase/server
└── middleware.ts      # Supabase session refresh, proteção de rotas (exceto /api/webhooks/pagarme, /auth/callback)
```

## Site Chrome (ConditionalSiteChrome)
- **Navbar, MobileMenu, SearchOverlay, CartDrawer, WhatsAppButton, Footer** são renderizados em todas as rotas **exceto** checkout.
- No checkout (`/checkout*`): apenas conteúdo da página, sem chrome.

## Checkout
- **One-page checkout:** formulário único (dados, endereço, frete, pagamento).
- **PIX:** 5% desconto; **Cartão:** 3x sem juros.
- Fluxo: CheckoutForm → API `/api/checkout/pagarme` → Pagar.me (PIX ou Cartão tokenizado).
- Webhook: `/api/webhooks/pagarme` (order.paid) cria pedido no Supabase, envia e-mail, cria venda no Bling.

## Font & Performance
- **Fonte:** Inter (display: optional, variable: --font-inter) — LCP otimizado.
- **Imagens:** Sempre `next/image`, `priority` para above-the-fold.
- **Dynamic import:** Componentes pesados (MobileMenu, CartDrawer, Footer) com dynamic() e ssr: false quando aplicável.

# Code Style & Quality

## TypeScript
- Strict typing. **NEVER** use `any`. Criar interfaces quando necessário.

## Componentes
- Funcionais, arrow functions.
- DRY e KISS.
- Componentes complexos → quebrar em `@/components/ui` ou pastas específicas (cart/, checkout/).
- Imports absolutos (`@/...`).

## Next.js App Router
- **Server Components** por padrão. `'use client'` só quando houver hooks ou interactividade.
- **Data fetching:** `await` direto em Server Components.
- **Server Actions:** Para mutations quando não for webhook externo. Checkout usa API Route (Pagar.me).
- **Routing:** `next/link` para navegação interna.

## Tailwind & UI
- Apenas utility classes. Ordem: Layout → Box Model → Typography → Visuals → Misc.
- Mobile-first. Breakpoints: `sm:`, `md:`, `lg:`.
- Animações: `framer-motion` ou Tailwind `transition` — sutis, sem movimentos bruscos.
- Padrão luxo: `uppercase`, `tracking-[0.2em]` ou `tracking-[0.25em]`, bordas `border-stone-200/80` ou `border-brand-softblack/10`, sombras leves.

## Supabase
- Tipos em `@/types/database.ts`.
- Nunca expor service keys no client.
- `createClient` (browser) vs `createServerClient` (middleware) vs service role (API routes).

# Cursor / AI Interaction
- Seja direto. Evite over-explanation.
- Ao sugerir mudanças, considere o impacto na estrutura do projeto.
- Instalação de pacotes: sempre `pnpm install ...`.

# Regras específicas VIOS Labs
- **Tom:** Técnico e preciso. Textos de UI elegantes ("Pharmaceutical Luxury").
- **Erros:** Tratar com grace. Usuário nunca deve ver dump de erro bruto.
- **SEO:** `metadata` em toda página (Title, Description, OpenGraph).

# Processos complexos (padrões validados)

## Bling API v3 — Integração vendas + NF-e
- **Token:** Tabela `bling_tokens` (id=1) + refresh via OAuth callback e pg_cron. `isBlingConfigured()` retorna true se `BLING_CLIENT_ID`+`BLING_CLIENT_SECRET` OU `BLING_ACCESS_TOKEN`/`BLING_REFRESH_TOKEN`.
- **Contato antes da venda:** API v3 exige `contato.id`. Criar contato via `POST /Api/v3/contatos` com: `nome`, `cpfCnpj`, `tipo` (F/J), `situacao: "A"`, `email`, `telefone`, **endereço completo** (`endereco`, `numero`, `complemento`, `bairro`, `cep`, `municipio`, `uf`) — NF-e exige todos os campos. Bairro: metadata ou ViaCEP; número: `"S/N"` se ausente.
- **Venda:** `POST /Api/v3/pedidos/vendas` com `contato: { id }`, `enderecoEntrega`, `itens` (id Bling, descricao, quantidade, valor), `valorTotal`, `numero: "VIOS-{pagarmeOrderId.slice(-8)}"`. **Produtos:** devem existir no Bling; mapear via `BLING_PRODUCT_ID_PROD_*` ou `BLING_PRODUCT_MAP`; rodar `/api/bling/sync-products` se necessário.
- **Escopos OAuth obrigatórios:** Gerenciar Contatos, Pedidos de venda; opcional: Clientes e Fornecedores.
- **Localizar venda no Bling:** Vendas > Pedidos de venda; **filtrar por data** (hoje, últimos 7 dias); status Em aberto/Ativo; buscar `VIOS-` ou número completo.
- **Erros Bling (padrão validado):** A API pode retornar a mensagem útil em `error.fields[].msg` (ex.: "O CPF já está cadastrado no contato Gabriel Teste") enquanto `error.message` é genérico ("Não foi possível salvar o contato"). **Sempre** montar um texto de erro completo concatenando `error.message` + todos os `error.fields[].msg` e usar esse texto único para: (1) detectar o tipo de erro (ex. "cpf já está cadastrado"); (2) extrair dados da mensagem (ex. nome do contato via regex). Assim o fallback (busca por CPF, por nome, lista paginada) funciona e reutilizamos o contato existente em vez de falhar.

## Pagar.me — Webhook order.paid
- **Endereço:** `addr = payload.data.shipping?.address ?? payload.data.customer?.address` (fallback).
- **Chamar Bling só se:** `addr?.zip_code`, `addr?.city`, `addr?.state` e `customerCpf` presentes.
- **Criar pedido Supabase** (orders + order_items) antes de Bling; e-mail e Bling em try/catch separados (não bloqueiam).

## Pagar.me — Checkout (criar pedido)
- **Incluir `shipping`** no payload: `{ amount, description, address }` para o webhook retornar `shipping.address`. Sem isso, usar fallback `customer.address`.

## Logs em produção
- `next.config` remove `console.log`; manter apenas `error` e `warn`. Para diagnósticos críticos (webhook, Bling): usar `console.warn`.

# Final Check
Antes de gerar código:
1. É type-safe?
2. É performante (Server vs Client Component)?
3. Parece "High-End"?
